"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[658],{9302:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>s,default:()=>h,frontMatter:()=>i,metadata:()=>o,toc:()=>l});var a=r(5893),t=r(1151);const i={},s="How To",o={id:"overview/how-to",title:"How To",description:"To build lambda API for CareSpan, it is best that it follows the following:",source:"@site/docs/01-overview/02-how-to.md",sourceDirName:"01-overview",slug:"/overview/how-to",permalink:"/api-lambda/docs/overview/how-to",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/01-overview/02-how-to.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{},sidebar:"docsSidebar",previous:{title:"What is inside?",permalink:"/api-lambda/docs/overview/what-is-inside"},next:{title:"Patient",permalink:"/api-lambda/docs/category/patient"}},d={},l=[{value:"Building a EMR lambda",id:"building-a-emr-lambda",level:2},{value:"Get from EHR",id:"get-from-ehr",level:3},{value:"1. Create a ehr handler",id:"1-create-a-ehr-handler",level:4},{value:"2. Fetch records based on input",id:"2-fetch-records-based-on-input",level:4},{value:"Return data in FHIR",id:"return-data-in-fhir",level:4},{value:"3. Ensure we have tracking in place",id:"3-ensure-we-have-tracking-in-place",level:4},{value:"4. Confirming toFhir is built",id:"4-confirming-tofhir-is-built",level:4},{value:"Add record to EHR",id:"add-record-to-ehr",level:3}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,t.a)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h1,{id:"how-to",children:"How To"}),"\n",(0,a.jsx)(n.p,{children:"To build lambda API for CareSpan, it is best that it follows the following:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Use CareSpan Middlewear"}),"\n",(0,a.jsxs)(n.li,{children:["Adhering to FHIR standard","\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Use FHIR resources whenever possible"}),"\n",(0,a.jsx)(n.li,{children:"Use FHIR parameters for searching, filtering, sort as much as possible"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"This how-to will describe how we write various lambdas"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"EMR Lambda"}),"\n",(0,a.jsx)(n.li,{children:"PMR Lambda (TBD)"}),"\n",(0,a.jsx)(n.li,{children:"Reporting Lambda (TBD)"}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"building-a-emr-lambda",children:"Building a EMR lambda"}),"\n",(0,a.jsxs)(n.p,{children:["There are ",(0,a.jsx)(n.a,{href:"https://carespan-health.github.io/ts-npm/docs/intro",children:"CareSpan NPM packages"})," that you will need to install in your project"]}),"\n",(0,a.jsx)(n.h3,{id:"get-from-ehr",children:"Get from EHR"}),"\n",(0,a.jsx)(n.h4,{id:"1-create-a-ehr-handler",children:"1. Create a ehr handler"}),"\n",(0,a.jsx)(n.p,{children:"Below is the boiler plate for creating a hander"}),"\n",(0,a.jsxs)(n.p,{children:["The example is to get a list of Care Plan (cat ",(0,a.jsx)(n.code,{children:"36"}),") from the EHR database and return as a bundle of Care Plan"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'import { APIGatewayProxyEvent } from "aws-lambda";\nimport getQuerySchema from "src/middleware/schema/input/getCarePlanRecordSchema";\nimport { getResponseFhirBundleSchema as getResponseSchema } from "@cscore/cs-api"\nimport HanderWrapper from "src/middleware/HandlerWrapper";\n\nconst getCarePlanHandler = async (\n    event: APIGatewayProxyEvent\n): Promise<any> => {\n    // ...\n};\n\n// wrap the middlewares\nexport const handler = HanderWrapper.wrapForFhir(getCarePlanHandler, {\n    inputSchema: getQuerySchema,\n    outputSchema: getResponseSchema,\n});\n'})}),"\n",(0,a.jsx)(n.p,{children:"The boiler plate imports all the must have information"}),"\n",(0,a.jsxs)(n.p,{children:["You can copy the boiler plate and repalce ",(0,a.jsx)(n.code,{children:"CarePlan"})," with something else"]}),"\n",(0,a.jsxs)(n.admonition,{type:"info",children:[(0,a.jsxs)(n.p,{children:["Do note one thing, here we need think about the inputs. In this case, we will allow patient guid as ",(0,a.jsx)(n.code,{children:"subject"}),". ",(0,a.jsx)(n.code,{children:"getQuerySchema"})," needs to be updated to allow ",(0,a.jsx)(n.code,{children:"subject"}),"."]}),(0,a.jsxs)(n.p,{children:["If you want to use the default input (only allowing 2 query parmeters: ",(0,a.jsx)(n.code,{children:"by-id"})," and ",(0,a.jsx)(n.code,{children:"client-id"}),"), you may use ",(0,a.jsx)(n.code,{children:"getQuerySchema"})," ffrom ",(0,a.jsx)(n.code,{children:"@cscore/cs-api"})]}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'import { getQuerySchema, getResponseFhirBundleSchema as getResponseSchema } from "@cscore/cs-api";\n\n'})})]}),"\n",(0,a.jsx)(n.h4,{id:"2-fetch-records-based-on-input",children:"2. Fetch records based on input"}),"\n",(0,a.jsx)(n.p,{children:"Next, you want to get all the inputs that you will need to run the function."}),"\n",(0,a.jsx)(n.p,{children:"In our case, we will need to:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Get the patient's cat ",(0,a.jsx)(n.code,{children:"36"})]}),"\n"]}),"\n",(0,a.jsxs)(n.admonition,{type:"info",children:[(0,a.jsx)(n.p,{children:"The below example assumes 2 things"}),(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"the CarePlan Value Object is created"}),"\n",(0,a.jsx)(n.li,{children:"CarePlan.toFhir is built"}),"\n"]})]}),"\n",(0,a.jsx)(n.p,{children:"Therefore, we will need to get the patient information"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"// update handler\nconst getCarePlanHandler = async (\n    event: APIGatewayProxyEvent\n): Promise<any> => {\n    // highlight-start\n    const patientGuid = event?.queryStringParameters?.subject;\n    const including = [36];\n\n    const lambda = new CarePlanLambda({});\n\n    // this is a ehr lambda, hence the init function can pull the records for us\n    const records = await lambda.init({\n        patientGuids: [patientGuid],\n        including,\n    });\n\n    const response = await lambda.run({\n        records,\n        patientGuid: patientGuid,\n        including,\n    });\n\n    return response;\n    // highlight-end\n};\n\n"})}),"\n",(0,a.jsx)(n.h4,{id:"return-data-in-fhir",children:"Return data in FHIR"}),"\n",(0,a.jsx)(n.p,{children:"Now we have the parameter, we can run our business logic"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// add to import\nimport { Bundle } from "fhir/r5";\nimport { EhrLambda } from "../EhrLambda";\n\n// add the CarePlanLambda class\nclass CarePlanLambda extends EhrLambda {\n    async run(params) {\n        const records = this.recordMap;\n        const bundle: Bundle = await this.getBundleFromRecords(records);\n        return this.renderSuccess(bundle);\n    }\n}\n\n// need to export this at the end if we want to inherit it\nexport { CarePlanLambda }\n'})}),"\n",(0,a.jsx)(n.h4,{id:"3-ensure-we-have-tracking-in-place",children:"3. Ensure we have tracking in place"}),"\n",(0,a.jsx)(n.p,{children:"We are building an EHR, hence everything we build needs to be tracked."}),"\n",(0,a.jsx)(n.p,{children:"Now, we have everything we need, but you will get an error as such"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"\u2716 Unhandled exception in handler 'getCarePlan'.\n\u2716 { InternalServerError: Missing steps!!\n      at csValidateProcessAfter (/Users/justinho/Projects/sandbox/lambda/ehr/carespan-ehr/node_modules/@cscore/cs-api/dist/index.js:14700:13)\n      ...\n    [cause]: { missingSteps: [ 'csEventTracking.setTrackingEvent' ] } }\n\u2716 Missing steps!!\n\n"})}),"\n",(0,a.jsx)(n.p,{children:"This is because we always need to track the event of what we do"}),"\n",(0,a.jsx)(n.p,{children:"More to come about events, but for now, we can do this"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// update the run function\n// add the CarePlanLambda class\nclass CarePlanLambda extends EhrLambda {\n    async run(params) {\n        const records = this.recordMap;\n        const bundle: Bundle = await this.getBundleFromRecords(records);\n        // highlight-start\n        // when there is no error, call the tracking function\n        await this.trackEvent(records, "read"); // the event detail is defined by the vo - in this case: src/vo/records/CarePlanRecord.ts\n        // highlight-end\n        return this.renderSuccess(bundle);\n    }\n}\n\n'})}),"\n",(0,a.jsx)(n.h4,{id:"4-confirming-tofhir-is-built",children:"4. Confirming toFhir is built"}),"\n",(0,a.jsx)(n.h3,{id:"add-record-to-ehr",children:"Add record to EHR"}),"\n",(0,a.jsx)(n.p,{children:"To add to the EHR, we can follow the boiler plate from the top and build on it"}),"\n",(0,a.jsx)(n.p,{children:"The steps would be:"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"Post FHIR resouce as body"}),"\n",(0,a.jsx)(n.li,{children:"Parse the FHIR resource and generate a CS object"}),"\n",(0,a.jsx)(n.li,{children:"Save the CS object in the database"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.a)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}},1151:(e,n,r)=>{r.d(n,{Z:()=>o,a:()=>s});var a=r(7294);const t={},i=a.createContext(t);function s(e){const n=a.useContext(i);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:s(e.components),a.createElement(i.Provider,{value:n},e.children)}}}]);